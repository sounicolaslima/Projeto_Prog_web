{% extends 'base.html' %}

{% block title %}Escalas - Gestão de Freelancers{% endblock %}

{% block content %}
<div class="w-full">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Escalas</h1>
            <p class="text-gray-500">Gestão de escalas e horários dos freelancers</p>
        </div>
        <a href="{% url 'cadastrar_escala' %}"
           class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">
            Cadastrar Escala
        </a>
    </div>

    <!-- Cards Resumo -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

        <div class="bg-blue-50 border border-blue-300 rounded-xl p-4 text-center">
            <div class="text-blue-700 text-3xl font-bold">{{ total_escalas }}</div>
            <p class="text-gray-600 text-sm">Total Geral</p>
        </div>

        <div class="bg-green-50 border border-green-300 rounded-xl p-4 text-center">
            <div class="text-green-700 text-3xl font-bold">{{ escalas_hoje }}</div>
            <p class="text-gray-600 text-sm">Hoje</p>
        </div>

        <div class="bg-yellow-50 border border-yellow-300 rounded-xl p-4 text-center">
            <div class="text-yellow-700 text-3xl font-bold">{{ escalas_semana }}</div>
            <p class="text-gray-600 text-sm">Esta Semana</p>
        </div>

        <div class="bg-cyan-50 border border-cyan-300 rounded-xl p-4 text-center">
            <div class="text-cyan-700 text-3xl font-bold">{{ escalas_mes }}</div>
            <p class="text-gray-600 text-sm">Este Mês</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white shadow-md rounded-xl p-5 mb-6">
        <h2 class="font-semibold text-gray-700 mb-4">Filtrar Escalas</h2>

        <form method="GET" class="grid grid-cols-1 md:grid-cols-5 gap-4">

            <select name="freelancer"
                    class="border rounded-lg p-2 text-gray-700">
                <option value="">Todos os freelancers</option>
                {% for f in freelancers %}
                <option value="{{ f.id }}" {% if freelancer_filter == f.id|stringformat:'s' %}selected{% endif %}>
                    {{ f.nome }}
                </option>
                {% endfor %}
            </select>

            <select name="status"
                    class="border rounded-lg p-2 text-gray-700">
                <option value="">Todos os status</option>
                <option value="Agendada" {% if status_filter == "Agendada" %}selected{% endif %}>Agendada</option>
                <option value="Em Andamento" {% if status_filter == "Em Andamento" %}selected{% endif %}>Em Andamento</option>
                <option value="Concluída" {% if status_filter == "Concluída" %}selected{% endif %}>Concluída</option>
            </select>

            <input type="date" name="data_inicio" value="{{ data_inicio }}"
                class="border rounded-lg p-2 text-gray-700">

            <input type="date" name="data_fim" value="{{ data_fim }}"
                class="border rounded-lg p-2 text-gray-700">

            <div class="flex flex-col gap-2">
                <button type="submit"
                        class="px-4 py-2 border border-blue-600 text-blue-700 rounded-lg hover:bg-blue-100 transition">
                    Filtrar
                </button>
                <a href="{% url 'listar_escalas' %}"
                   class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition text-center">
                    Limpar
                </a>
            </div>
        </form>
    </div>

    <!-- Lista -->
    <div class="bg-white shadow-md rounded-xl">

        <div class="border-b px-5 py-3 bg-blue-600 text-white rounded-t-xl">
            <h3 class="font-semibold">
                Lista de Escalas
                {% if freelancer_filter or status_filter or data_inicio or data_fim %}
                <span class="text-sm">(Filtrado)</span>
                {% endif %}
            </h3>
        </div>

        <div class="p-0">
            {% if escalas %}
            <div class="overflow-x-auto">
                <table class="w-full text-left text-gray-700">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4">Freelancer</th>
                            <th class="py-3 px-4">Data</th>
                            <th class="py-3 px-4">Horário</th>
                            <th class="py-3 px-4">Duração</th>
                            <th class="py-3 px-4">Status</th>
                            <th class="py-3 px-4 text-center">Ações</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for e in escalas %}
                        <tr class="border-b hover:bg-gray-50">

                            <td class="py-3 px-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 flex items-center justify-center bg-blue-100 rounded-full text-blue-700 font-bold">
                                        {{ e.freelancer.nome|first }}
                                    </div>
                                    <div>
                                        <div class="font-semibold">{{ e.freelancer.nome }}</div>
                                        <div class="text-gray-500 text-sm">{{ e.freelancer.contato }}</div>
                                    </div>
                                </div>
                            </td>

                            <td class="py-3 px-4">
                                <span class="font-semibold">{{ e.data|date:"d/m/Y" }}</span><br>
                                <span class="text-gray-500 text-sm">{{ e.data|date:"l" }}</span>
                            </td>

                            <td class="py-3 px-4">
                                <span class="text-green-600 font-semibold">{{ e.horario_inicio|time:"H:i" }}</span><br>
                                <span class="text-gray-500 text-sm">às</span><br>
                                <span class="text-red-600 font-semibold">{{ e.horario_fim|time:"H:i" }}</span>
                            </td>

                            <td class="py-3 px-4 font-semibold text-blue-600">
                                {{ e.duracao }}h
                            </td>

                            <td class="py-3 px-4">
                                {% if e.status == "Concluída" %}
                                <span class="px-3 py-1 rounded-lg bg-green-100 text-green-700 text-sm">
                                    {{ e.status }}
                                </span>

                                {% elif e.status == "Em Andamento" %}
                                <span class="px-3 py-1 rounded-lg bg-yellow-100 text-yellow-700 text-sm">
                                    {{ e.status }}
                                </span>

                                {% else %}
                                <span class="px-3 py-1 rounded-lg bg-blue-100 text-blue-700 text-sm">
                                    {{ e.status }}
                                </span>
                                {% endif %}
                            </td>

                            <!-- Ações -->
                            <td class="py-3 px-4 text-center">

                                <div class="flex justify-center gap-2">
                                    <a href="{% url 'visualizar_escala' e.id %}"
                                       class="px-3 py-1 text-sm border rounded-lg hover:bg-gray-100">
                                        Ver
                                    </a>

                                    <a href="{% url 'editar_escala' e.id %}"
                                       class="px-3 py-1 text-sm border rounded-lg hover:bg-yellow-100">
                                        Editar
                                    </a>

                                    <button onclick="openModal('modal{{ e.id }}')"
                                            class="px-3 py-1 text-sm border border-red-600 text-red-600 rounded-lg hover:bg-red-100">
                                        Excluir
                                    </button>
                                </div>

                                <!-- Modal Tailwind -->
                                <div id="modal{{ e.id }}"
                                     class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
                                    <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6">

                                        <h2 class="text-lg font-semibold text-red-600 mb-4">
                                            Confirmar Exclusão
                                        </h2>

                                        <p class="text-gray-700 mb-3">Tem certeza que deseja excluir esta escala?</p>

                                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4">
                                            <p class="font-semibold">{{ e.freelancer.nome }}</p>
                                            <p>Data: {{ e.data|date:"d/m/Y" }}</p>
                                            <p>Horário: {{ e.horario_inicio }} - {{ e.horario_fim }}</p>
                                        </div>

                                        <div class="flex justify-end gap-3">
                                            <button onclick="closeModal('modal{{ e.id }}')"
                                                    class="px-4 py-2 rounded-lg border hover:bg-gray-100">
                                                Cancelar
                                            </button>

                                            <form method="POST" action="{% url 'excluir_escala' e.id %}">
                                                {% csrf_token %}
                                                <button class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                                    Excluir
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% else %}
            <div class="text-center py-10">
                <p class="text-gray-600 text-lg">Nenhuma escala encontrada</p>
                <a href="{% url 'cadastrar_escala' %}"
                   class="mt-4 inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Cadastrar primeira escala
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Próximos 7 dias -->
    <div class="bg-white shadow-md rounded-xl mt-6 p-5">
        <h2 class="font-semibold text-gray-700 mb-4">Próximos 7 Dias</h2>

        <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
            {% for dia in proximos_dias %}
            <div class="border rounded-lg p-3 text-center">
                <div class="font-semibold text-blue-700">{{ dia.data|date:"d/m" }}</div>
                <div class="text-gray-500 text-sm">{{ dia.data|date:"D" }}</div>
                <span class="mt-2 inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm">
                    {{ dia.total_escalas }} escala(s)
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- JS para modal -->
<script>
function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
    document.getElementById(id).classList.add('flex');
}
function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}
</script>

{% endblock %}
