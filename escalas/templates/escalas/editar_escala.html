{% extends 'base.html' %}

{% block title %}Editar Escala - Gestão de Freelancers{% endblock %}

{% block content %}

<div class="flex justify-center">
    <div class="w-full max-w-3xl">

        <!-- Card -->
        <div class="bg-white shadow-md rounded-xl border">

            <!-- Cabeçalho -->
            <div class="bg-yellow-500 text-white px-6 py-4 rounded-t-xl">
                <h4 class="text-xl font-semibold">
                    Editar Escala
                </h4>
            </div>

            <div class="p-6">
                <form method="post">
                    {% csrf_token %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Freelancer -->
                        <div class="col-span-2">
                            <label class="block font-semibold mb-1">Freelancer</label>
                            <select name="freelancer" required
                                class="w-full border rounded-lg px-4 py-3 text-gray-700 focus:ring focus:ring-yellow-300">
                                {% for f in freelancers %}
                                <option value="{{ f.id }}" {% if f.id == escala.freelancer.id %}selected{% endif %}
                                    data-valor-hora="{{ f.valor_hora }}">
                                    {{ f.nome }} - R$ {{ f.valor_hora }}/hora
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Data -->
                        <div>
                            <label class="block font-semibold mb-1">Data</label>
                            <input type="date" name="data" value="{{ escala.data|date:'Y-m-d' }}" required
                                class="w-full border rounded-lg px-4 py-3 text-gray-700 focus:ring focus:ring-yellow-300">
                        </div>

                        <!-- Horário Início -->
                        <div>
                            <label class="block font-semibold mb-1">Horário Início</label>
                            <input type="time" name="horario_inicio" value="{{ escala.horario_inicio|time:'H:i' }}" required
                                class="w-full border rounded-lg px-4 py-3 text-gray-700 focus:ring focus:ring-yellow-300">
                        </div>

                        <!-- Horário Fim -->
                        <div>
                            <label class="block font-semibold mb-1">Horário Fim</label>
                            <input type="time" name="horario_fim" value="{{ escala.horario_fim|time:'H:i' }}" required
                                class="w-full border rounded-lg px-4 py-3 text-gray-700 focus:ring focus:ring-yellow-300">
                        </div>

                        <!-- Resumo -->
                        <div class="col-span-2">
                            <div class="bg-gray-50 border rounded-xl p-5">
                                <h6 class="font-semibold mb-4">Resumo da Escala</h6>

                                <div class="grid grid-cols-3 text-center">

                                    <!-- Duração -->
                                    <div>
                                        <small class="text-gray-500">Duração Total</small>
                                        <p class="font-semibold text-blue-600">{{ escala.duracao }}h</p>
                                    </div>

                                    <!-- Valor Hora -->
                                    <div>
                                        <small class="text-gray-500">Valor por Hora</small>
                                        <p class="font-semibold text-green-600">R$ {{ escala.freelancer.valor_hora }}</p>
                                    </div>

                                    <!-- Status -->
                                    <div>
                                        <small class="text-gray-500">Status Atual</small>
                                        <p class="font-semibold
                                            {% if escala.status == 'Concluída' %}
                                                text-green-600
                                            {% elif escala.status == 'Em Andamento' %}
                                                text-yellow-600
                                            {% else %}
                                                text-blue-600
                                            {% endif %}
                                        ">
                                            {{ escala.status }}
                                        </p>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Ações -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8 border-t pt-6">

                        <button type="submit"
                            class="w-full bg-yellow-500 text-white py-3 rounded-lg font-semibold hover:bg-yellow-600 transition">
                            Atualizar Escala
                        </button>

                        <a href="{% url 'visualizar_escala' escala.id %}"
                            class="w-full border border-blue-600 text-blue-600 py-3 rounded-lg font-semibold text-center hover:bg-blue-50 transition">
                            Ver Detalhes
                        </a>

                        <a href="{% url 'listar_escalas' %}"
                            class="w-full border border-gray-500 text-gray-700 py-3 rounded-lg font-semibold text-center hover:bg-gray-100 transition">
                            Voltar para Lista
                        </a>

                    </div>

                </form>
            </div>

        </div>

    </div>
</div>

<script>
    function calcularEscala() {
        const inicio = document.querySelector('input[name="horario_inicio"]').value;
        const fim = document.querySelector('input[name="horario_fim"]').value;
        const select = document.querySelector('select[name="freelancer"]');
        const valor = select.selectedOptions[0]?.dataset.valorHora;

        if (inicio && fim && valor) {
            const [h1, m1] = inicio.split(':').map(Number);
            const [h2, m2] = fim.split(':').map(Number);

            let mins = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (mins < 0) mins += 1440;

            const h = Math.floor(mins / 60);
            const m = mins % 60;

            const total = (mins / 60) * parseFloat(valor);

            document.getElementById("duracaoTotal").textContent = `${h}h ${m}min`;
            document.getElementById("valorHora").textContent = `R$ ${parseFloat(valor).toFixed(2)}`;
            document.getElementById("valorTotal").textContent = `R$ ${total.toFixed(2)}`;
        }
    }
</script>

{% endblock %}
